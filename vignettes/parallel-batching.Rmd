---
title: "Parallel batching and chunking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parallel batching and chunking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
eval_site <- TRUE
if (requireNamespace("pkgdown", quietly = TRUE)) eval_site <- pkgdown::in_pkgdown()
if (eval_site && requireNamespace("curl", quietly = TRUE)) eval_site <- curl::has_internet()
knitr::opts_chunk$set(eval = eval_site, message = FALSE, warning = FALSE, error = FALSE)
if (requireNamespace("remotes", quietly = TRUE)) {
  try(remotes::install_local(".", upgrade = "never", force = TRUE, dependencies = FALSE), silent = TRUE)
}
```

```{r}
library(mongolstats)
library(dplyr)
```

## Batch multiple tables

`nso_package()` accepts a list (or data frame) of requests and binds results.

```{r}
reqs <- list(
  list(tbl_id = "DT_NSO_0300_001V2", selections = list(Year = "2024", Sex = "Total", Age = "Total"))
)
res <- tryCatch(nso_package(reqs, labels = "code"), error = function(e) tibble::tibble())
res %>% dplyr::slice_head(n = 5)
```

## Enable parallel batching

If `future.apply` is installed, set `parallel = TRUE` to compute requests concurrently.
Control workers with `future::plan()`.

```{r}
if (requireNamespace("future", quietly = TRUE) && requireNamespace("future.apply", quietly = TRUE)) {
  future::plan(future::multisession, workers = 2)
  res_par <- tryCatch(nso_package(reqs, labels = "code", parallel = TRUE), error = function(e) NULL)
  future::plan(future::sequential)
}
```

## Chunk large selections

To avoid very large requests, split a dimension into smaller chunks and combine results.

```{r}
years <- c("2020","2021","2022","2023","2024")
chunks <- split(years, ceiling(seq_along(years) / 2))  # chunks of 2
parts <- lapply(chunks, function(yrs) {
  tryCatch(nso_data("DT_NSO_0300_001V2", list(Year = yrs, Sex = "Total", Age = "Total"), labels = "code"), error = function(e) tibble::tibble())
})
res_chunked <- dplyr::bind_rows(parts)
if ("Year" %in% names(res_chunked)) {
  res_chunked %>% dplyr::count(Year)
} else {
  tibble::tibble()
}
```

## Progress bars

Enable package progress for multi-request batches. Sequential (non-parallel) batches will display a progress bar when `cli` is available and the session is interactive.

```{r}
options(mongolstats.progress = TRUE)
res <- tryCatch(nso_package(reqs, labels = "code", parallel = FALSE), error = function(e) NULL)
```

Tips
- Use caching (`nso_cache_enable()`) to speed up metadata lookups.
- Prefer chunking across the time dimension or least-cardinality dimension.
- Use `parallel = TRUE` for independent requests, not for a single huge table fetch.
