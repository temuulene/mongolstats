---
title: "Getting Started with mongolstats"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with mongolstats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.width = 8,
    fig.height = 6,
    warning = FALSE,
    message = FALSE
)
```

## Installation

Install from GitHub:

```{r install, eval=TRUE}
# install.packages("devtools")
# devtools::install_github("temuulene/mongolstats")
```

## Your First Analysis: Infant Mortality Trends

Let's walk through a complete workflow using infant mortality data—a key indicator of population health and health system performance.

### Step 1: Load Packages

```{r setup}
library(mongolstats)
library(dplyr)
library(ggplot2)

# Set language to English for readable output
nso_options(mongolstats.lang = "en")
```

### Step 2: Find the Right Table

Search for infant mortality data:

```{r search, eval=TRUE}
# Search by keyword
mortality_tables <- nso_itms_search("infant mortality")
mortality_tables |>
    select(tbl_id, tbl_eng_nm) |>
    head(5)
```

We'll use `DT_NSO_2800_019V1` - Infant Mortality Rate per 1,000 live births.

### Step 3: Explore Table Metadata

Before fetching data, check what dimensions are available:

```{r metadata, eval=TRUE}
# View table structure
meta <- nso_table_meta("DT_NSO_2800_019V1")
meta

# Check available years (data available from 1990-2015)
time_vals <- nso_dim_values("DT_NSO_2800_019V1", "Time (Annual)", labels = "en")
head(time_vals, 10)
```

### Step 4: Fetch Data

Get national infant mortality rates for the past two decades:

```{r fetch-data, eval=TRUE}
imr_national <- nso_data(
    tbl_id = "DT_NSO_2800_019V1",
    selections = list(
        "Aimag" = "Total", # National level
        "Time (Annual)" = c("2010", "2011", "2012", "2013", "2014", "2015")
    ),
    labels = "en" # Get English labels
)

# Preview
imr_national |>
    head(10)
```

### Step 5: Visualize the Trend

Create a publication-ready plot:

```{r plot-trend, eval=TRUE, fig.alt="Line plot showing decline in infant mortality rate from 2010 to 2015"}
imr_national |>
    mutate(year = as.integer(`Time (Annual)_en`)) |>
    ggplot(aes(x = year, y = value)) +
    geom_line(color = "#2c3e50", linewidth = 1.2) +
    geom_point(color = "#e74c3c", size = 4, shape = 21, fill = "white", stroke = 2) +
    geom_smooth(method = "loess", se = TRUE, color = "#3498db", fill = "#3498db", alpha = 0.1) +
    scale_x_continuous(breaks = scales::pretty_breaks()) +
    labs(
        title = "Infant Mortality Rate in Mongolia",
        subtitle = "Deaths per 1,000 live births (National Trend)",
        x = NULL,
        y = "IMR",
        caption = "Source: NSO Mongolia via mongolstats"
    ) +
    theme_minimal(base_size = 14) +
    theme(
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(color = "grey40"),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()
    )
```

## Regional Comparison

Compare infant mortality across different regions:

```{r regional, eval=TRUE}
# Get all aimags for most recent year
imr_regional <- nso_data(
    tbl_id = "DT_NSO_2800_019V1",
    selections = list(
        "Aimag" = nso_dim_values("DT_NSO_2800_019V1", "Aimag")$code,
        "Time (Annual)" = "2015" # Most recent year in dataset
    ),
    labels = "en"
) |>
    filter(Aimag != "0") |> # Exclude national total
    filter(Aimag != "511") |> # Exclude duplicate Ulaanbaatar code
    mutate(
        Aimag_en = trimws(Aimag_en),
        Type = ifelse(Aimag %in% c("1", "2", "3", "4"), "Region", "Aimag")
    )

# Top 10 highest IMR regions
imr_regional |>
    arrange(desc(value)) |>
    select(Aimag_en, value) |>
    head(10)
```

### Visualize Regional Disparities

```{r regional-plot, eval=TRUE, fig.alt="Bar chart comparing infant mortality rates across Mongolia's aimags", fig.height=8}
imr_regional |>
    arrange(desc(value)) |>
    mutate(Aimag_en = forcats::fct_reorder(Aimag_en, value)) |>
    ggplot(aes(x = value, y = Aimag_en)) +
    # Aimags with gradient
    geom_col(data = ~ subset(., Type == "Aimag"), aes(fill = value), width = 0.7) +
    # Regions with distinct color
    geom_col(data = ~ subset(., Type == "Region"), fill = "#2c3e50", width = 0.7) +
    geom_text(aes(label = round(value, 1)), hjust = -0.2, color = "grey30", size = 3.5) +
    scale_fill_gradient2(
        low = "#27ae60",
        mid = "#f39c12",
        high = "#e74c3c",
        midpoint = median(imr_regional$value[imr_regional$Type == "Aimag"])
    ) +
    geom_vline(
        xintercept = median(imr_regional$value[imr_regional$Type == "Aimag"]),
        linetype = "dashed",
        color = "grey50",
        linewidth = 0.5
    ) +
    scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
    labs(
        title = "Infant Mortality by Aimag (2015)",
        subtitle = "Dark bars represent Regional Averages",
        x = "Deaths per 1,000 live births",
        y = NULL
    ) +
    theme_minimal(base_size = 12) +
    theme(
        plot.title = element_text(face = "bold", size = 14),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(color = "black")
    )
```

## Adding Geographic Context

Combine with mapping for spatial analysis:

```{r map-example, eval=TRUE, fig.alt="Choropleth map of infant mortality rates across Mongolia"}
library(sf)

# Get aimag boundaries
aimags <- mn_boundaries(level = "ADM1")

# Join IMR data to map
imr_map <- aimags |>
    left_join(imr_regional, by = c("shapeName" = "Aimag_en"))

# Create choropleth
imr_map |>
    ggplot() +
    geom_sf(aes(fill = value), color = "white", size = 0.2) +
    scale_fill_viridis_c(
        option = "magma",
        direction = -1,
        name = "IMR per\n1,000",
        labels = scales::label_number()
    ) +
    labs(
        title = "Infant Mortality Geography (2015)",
        subtitle = "Spatial distribution of mortality rates",
        caption = "Source: NSO Mongolia"
    ) +
    theme_void() +
    theme(
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(color = "grey40"),
        legend.position = "right",
        legend.title = element_text(size = 10, face = "bold")
    )
```

## Key Functions Summary

| Function | Purpose | Example |
|----------|---------|---------|
| `nso_itms_search()` | Find tables by keyword | `nso_itms_search("mortality")` |
| `nso_table_meta()` | Get table dimensions | `nso_table_meta("DT_NSO_...")` |
| `nso_dim_values()` | List dimension values | `nso_dim_values(tbl, "Region")` |
| `nso_table_periods()` | Check time coverage | `nso_table_periods(tbl)` |
| `nso_data()` | Fetch data | `nso_data(tbl, selections, labels)` |
| `mn_boundaries()` | Get geographic boundaries | `mn_boundaries(level = "ADM1")` |

## Best Practices

1. **Always use labels**: Set `labels = "en"` in `nso_data()` for readable output
2. **Check metadata first**: Use `nso_table_meta()` to understand dimensions before fetching
3. **Use appropriate selections**: Specify dimensions by their English labels (e.g., `"Total"` not `"0"`)
4. **Filter carefully**: Exclude total rows (usually code `"0"`) when analyzing subgroups
5. **Clean labels**: Use `trimws()` to remove leading/trailing spaces from region names before joining

## Common Workflows

### Time Series Analysis
1. Search for table → Check periods → Fetch years → Plot trend

### Regional Comparison  
1. Search table → Get all regions → Fetch latest year → Compare rates

### Spatial Epidemiology
1. Fetch regional data → Get boundaries → Join → Create choropleth

## Next Steps

- **Discover More Data**: See the [Discovery Guide](discovery.html) for advanced search techniques
- **Create Maps**: Learn spatial analysis in the [Mapping Guide](mapping.html)  
- **Reference**: Browse all functions in the [Reference](../reference/index.html)

## Quick Reference: Common Health Tables

```{r health-tables, echo=FALSE, eval=TRUE}
tibble::tribble(
    ~Indicator, ~Table_ID,
    "Infant Mortality", "DT_NSO_2800_019V1",
    "Maternal Mortality", "DT_NSO_2100_050V1",
    "Under-5 Mortality", "DT_NSO_2100_030V2",
    "Cancer Incidence", "DT_NSO_2100_012V1",
    "TB Incidence", "DT_NSO_2800_026V1",
    "Communicable Diseases", "DT_NSO_2100_020V2"
) |>
    knitr::kable()
```
