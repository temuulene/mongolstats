---
title: "Mapping with mongolstats"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mapping with mongolstats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
eval_site <- TRUE
if (requireNamespace("pkgdown", quietly = TRUE)) eval_site <- pkgdown::in_pkgdown()
if (eval_site && requireNamespace("curl", quietly = TRUE)) eval_site <- curl::has_internet()
knitr::opts_chunk$set(eval = eval_site, message = FALSE, warning = FALSE, error = TRUE)
if (eval_site) {
  options(mongolstats.retry_tries = 5L, mongolstats.timeout = 60)
  try(mongolstats::nso_cache_enable(), silent = TRUE)
}
```

```{r}
library(mongolstats)
library(dplyr)
library(sf)
```

This vignette shows how to join data to ADM1 boundaries by name.

```{r}
adm1 <- mn_boundaries("ADM1") %>% mn_boundaries_normalize()
head(adm1$name_std)
```

Suppose we fetched a table that reports values by aimag:

```{r}
tbl <- "DT_NSO_0300_004V5"  # Resident population by location and region

periods <- nso_table_periods(tbl)
dat <- if (length(periods)) nso_data(tbl, selections = list(Year = tail(periods, 1)), labels = "en") else tibble::tibble()

# Create a name column from the 'Region' dimension if present
if ("Region_en" %in% names(dat)) dat$name <- dat$Region_en else if ("Region" %in% names(dat)) dat$name <- dat$Region

joined <- tryCatch(mn_join_by_name(dat, name_col = "name", level = "ADM1"), error = function(e) adm1)
plot(sf::st_geometry(joined))
```

Note: Name-based joins are heuristic. For rigorous joins, prefer stable codes
once a consistent NSO geographic classification is identified.
