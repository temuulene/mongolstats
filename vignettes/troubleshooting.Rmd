---
title: "Troubleshooting PXWeb requests"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Troubleshooting PXWeb requests}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
eval_site <- TRUE
if (requireNamespace("pkgdown", quietly = TRUE)) eval_site <- pkgdown::in_pkgdown()
if (eval_site && requireNamespace("curl", quietly = TRUE)) eval_site <- curl::has_internet()
knitr::opts_chunk$set(eval = eval_site, message = FALSE, warning = FALSE, error = FALSE)
if (eval_site) {
  options(mongolstats.retry_tries = 5L, mongolstats.timeout = 60)
  try(mongolstats::nso_cache_enable(), silent = TRUE)
}
if (requireNamespace("remotes", quietly = TRUE)) {
  try(remotes::install_local(".", upgrade = "never", force = TRUE, dependencies = FALSE), silent = TRUE)
}
```

```{r}
library(mongolstats)
library(dplyr)
nso_options(mongolstats.lang = "en")
```

## Common errors and fixes

### 400 Bad Request (dimension not selected)

PXWeb requires a selection for every dimension. `mongolstats` includes all unspecified dimensions automatically, but invalid labels/codes still fail.

Fix: Inspect dimensions and values; select by code or label.

```{r}
dims <- tryCatch(nso_dims("DT_NSO_0300_001V2"), error = function(e) tibble::tibble())
vals_year <- tryCatch(nso_dim_values("DT_NSO_0300_001V2", "Year", labels = "en"), error = function(e) tibble::tibble())
head(vals_year)
```

### Label/code mismatch

If labels are used where codes are required, `mongolstats` maps labels to codes when possible. When ambiguous, it errors with candidates.

Fix: Prefer exact labels from `nso_dim_values()` or select codes directly.

```{r}
q <- nso_query("DT_NSO_0300_001V2", list(Year = "2024", Sex = c("Male","Female"), Age = "Total"))
dat <- tryCatch(nso_fetch(q, labels = "en"), error = function(e) tibble::tibble())
head(dat)
```

### Timeouts / 413 Payload Too Large

Large selections can be slow or rejected. Reduce the number of values per dimension, or fetch in batches.

Tips:
- Narrow your Year range or category lists.
- Fetch multiple slices and `bind_rows()` them.
- Use caching to avoid repeated metadata calls: `nso_cache_enable(ttl = 7 * 24 * 3600)`.

### Offline errors

When offline mode is enabled, network calls error fast with a typed condition.

```{r}
nso_offline_enable()
try(nso_sectors(), silent = TRUE)
nso_offline_disable()
```

### Debugging requests

Enable verbose logging to inspect URLs and payloads.

```{r}
options(mongolstats.verbose = TRUE)
invisible(try(nso_data("DT_NSO_0300_001V2", list(Year = "2024", Sex = "Total", Age = "Total")), silent = TRUE))
options(mongolstats.verbose = FALSE)
```

## Best practices

- Discover with `nso_itms()` + `nso_search()`; inspect with `nso_dims()` and `nso_dim_values()`.
- Keep examples fast; cache metadata during development.
- Prefer code selections for stable scripts; add labels via `labels = 'en'` when needed.
- Guard long-running chunks in vignettes with internet checks.
