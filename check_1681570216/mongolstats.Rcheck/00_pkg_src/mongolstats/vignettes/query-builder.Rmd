---
title: "Query builder: dims → query → fetch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Query builder: dims → query → fetch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
eval_site <- TRUE
if (requireNamespace("pkgdown", quietly = TRUE)) eval_site <- pkgdown::in_pkgdown()
if (eval_site && requireNamespace("curl", quietly = TRUE)) eval_site <- curl::has_internet()
knitr::opts_chunk$set(eval = eval_site, message = FALSE, warning = FALSE, error = TRUE)
if (eval_site) {
  options(mongolstats.retry_tries = 5L, mongolstats.timeout = 60)
  try(mongolstats::nso_cache_enable(), silent = TRUE)
}
if (requireNamespace("remotes", quietly = TRUE)) {
  try(remotes::install_local(".", upgrade = "never", force = TRUE, dependencies = FALSE), silent = TRUE)
}
```

```{r}
library(mongolstats)
library(dplyr)
nso_options(mongolstats.lang = "en")
```

## Inspect dimensions

Use `nso_dims()` to list table dimensions and `nso_dim_values()` to inspect codes/labels for a dimension.

```{r}
dims <- nso_dims("DT_NSO_0300_001V2")
dims

nso_dim_values("DT_NSO_0300_001V2", "Year", labels = "en") %>% slice_head(n = 6)
```

## Build a query

Construct a query with readable selections (codes or labels). Print shows a compact summary.

```{r}
yr <- tryCatch(tail(nso_table_periods("DT_NSO_0300_001V2"), 1), error = function(e) "2022")
q <- nso_query(
  tbl_id = "DT_NSO_0300_001V2",
  selections = list(Year = yr, Sex = c("Male","Female"), Age = "Total")
)
q
```

## Execute the query

Use `nso_fetch()` to run the query. Add labels for readability when needed.

```{r}
dat <- nso_fetch(q, labels = "en")
dat %>% select(dplyr::any_of(c("Year","Sex","Age","value","Year_en","Sex_en"))) %>% slice_head(n = 8)
```

## Tips

- Use `nso_dim_values(tbl, dim, labels = 'en')` to discover valid values.
- Selections accept codes or labels; mongolstats maps labels to codes.
- Enable caching for faster iteration: `nso_cache_enable()`.

